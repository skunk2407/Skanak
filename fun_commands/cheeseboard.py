import discord
from discord.ext import commands
from discord import app_commands
import json
import os

class CheeseBoard(commands.Cog):
    def __init__(self, bot: commands.Bot):
        self.bot = bot
        self.leaderboard_file = os.path.join(os.path.dirname(__file__), "cheese_leaderboard.json")
        
        # V√©rifier si le fichier de leaderboard existe
        if not os.path.exists(self.leaderboard_file):
            # Cr√©er le fichier et initialiser le leaderboard
            with open(self.leaderboard_file, 'w') as f:
                json.dump([], f)  # Initialiser le fichier avec une liste vide

    @app_commands.command(name='cheeseboard', description='Show the Certified Cheese Enjoyers leaderboard.')
    async def cheeseboard(self, interaction: discord.Interaction):
        # Charger le leaderboard
        with open(self.leaderboard_file, 'r') as f:
            leaderboard = json.load(f)

        if not leaderboard:
            await interaction.response.send_message("The leaderboard is empty.")
        else:
            # Cr√©er un embed pour le leaderboard avec une couleur jaune
            embed = discord.Embed(
                title="üèÜ Certified Cheese Enjoyers Leaderboard üèÜ",
                color=discord.Color.from_rgb(255, 255, 102)  # Couleur jaune
            )

            # Ajouter des champs avec le classement et les noms avec l'emoji de fromage
            cheese_emoji = "üßÄ"  # Emoji de fromage
            for index, entry in enumerate(leaderboard, start=1):
                embed.add_field(name=f"**{index}. {entry['name']} {cheese_emoji}**", value="\u200b", inline=False)

            await interaction.response.send_message(embed=embed)

    @commands.Cog.listener()
    async def on_member_update(self, before, after):
        role_id = 1296169417172062259  # ID du r√¥le "CERTIFIED CHEESE ENJOYER"
        
        if before.roles != after.roles:  # V√©rifier si les r√¥les ont chang√©
            if discord.utils.get(after.roles, id=role_id):  # Si le membre a maintenant le r√¥le
                # V√©rifier si le membre est d√©j√† dans le leaderboard
                with open(self.leaderboard_file, 'r') as f:
                    leaderboard = json.load(f)

                # Ajouter le membre s'il n'est pas d√©j√† dans le leaderboard
                if not any(entry['id'] == after.id for entry in leaderboard):
                    leaderboard.append({'id': after.id, 'name': after.name})
                    
                    # Sauvegarder le leaderboard mis √† jour
                    with open(self.leaderboard_file, 'w') as f:
                        json.dump(leaderboard, f)

async def setup(bot: commands.Bot):
    await bot.add_cog(CheeseBoard(bot))
